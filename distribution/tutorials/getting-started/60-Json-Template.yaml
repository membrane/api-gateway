# yaml-language-server: $schema=../../core/target/classes/com/predic8/membrane/core/config/json/membrane.schema.json
#
# Membrane Tutorial: Jsonpath
#
# curl -d @data/order.json -H "Content-Type: application/json" localhost:2000
#
# Troubleshooting:
#   Do not forget the Content-Type header with value application/json!

spec:
  port: 2000
  flow:
    - request:
        - setProperty:
            name: id
            value: ${$.id}
            language: jsonpath
        - setProperty:
            name: items
            value: ${$.items}
            language: jsonpath
    - response:
        - template:
            contentType: application/json
            pretty: true
            src: |
              {
                "number": ${property.id}
                "positions": [
                  <% for (item in property.items) { %>
                    "product": "<%= item.article %>",
                    "quantity": <%= item.quantity %>,
                    "amount": <%= item.quantity * item.price %>,
                  <% } %>
                ]
              }
    - return:
        statusCode: 200
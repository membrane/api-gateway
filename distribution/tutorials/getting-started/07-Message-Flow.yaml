# yaml-language-server: $schema=../../core/target/classes/com/predic8/membrane/core/config/json/membrane.schema.json
#
# Membrane Tutorial: Message Flow
#
# API Gateways get their power from plugins. A plugin is a piece of code that is executed at a specific point in the request/response flow.
# Membrane offers fine control when a plugin is executed.
#
# 1.) Call the API on port 2000:
# curl localhost:2000
# Observe the log output on the console. The message is printed twice: once at the request and once at the response. The status code is only printed
# in the second log message after the response was received from the backend.
#
#
# 2.) Call the API on port 2001:
# curl localhost:2001
#
# Attention: Make sure you change the port
#
# 3.) Open the admin console in the browser.
#   http://localhost:9000
#   Click on the API `Message Flow Logging` and take a look at the diagram

spec:
  port: 2000
  flow:
    # log is executed at the request and response flow
    - log:
        message: Path ${path} Status ${statusCode}
  target:
    url: https://api.predic8.de

---
metadata:
  name: Message Flow Logging
spec:
  port: 2001
  flow:
    - request: # executed at the request flow from top to bottom
        - log:
            message: 1
        - log:
            message: 2 Path ${path}
        - log:
            message: 3
    - response: # executed at the response flow from bottom to top
        - log:
            message: 6
        - log:
            message: 5 Status ${statusCode}
        - log:
            message: 4
  target:
    url: https://api.predic8.de

---
# Admin Console
spec:
  port: 9000
  flow:
    - adminConsole:
        readOnly: true
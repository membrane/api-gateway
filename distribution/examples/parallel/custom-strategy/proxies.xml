<spring:beans xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns="http://membrane-soa.org/proxies/1/"
              xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
					    http://membrane-soa.org/proxies/1/ http://membrane-soa.org/schemas/proxies-1.xsd">

    <router>

        <api port="2000">
            <log />
            <parallel>
                <custom><![CDATA[
                    // Initialize min_value if it doesn't exist
                    if (vars["min_value"] == null) {
                        vars["min_value"] = Integer.MAX_VALUE
                    }

                    // Get the current x-value from the response header and parse it as an integer
                    def currentValue = Integer.parseInt(current.getResponse().getHeader().getFirstValue("x-value"))

                    // Compare currentValue with min_value and update if necessary
                    if (currentValue < vars["min_value"]) {
                        vars["min_value"] = currentValue
                        vars["min_value_exchange"] = current
                    }

                    // Return min_value when all exchanges have finished
                    if (running.isEmpty()) {
                        return vars["min_value_exchange"]
                    } else {
                        return null
                    }
                ]]></custom>
                <target url="http://localhost:3000" />
                <target url="http://localhost:4000" />
                <target url="http://localhost:5000" />
            </parallel>
        </api>

        <api port="3000">
            <setHeader name="x-value" value="1" />
            <static>
                Number 1
            </static>
            <return />
        </api>

        <api port="4000">
            <setHeader name="x-value" value="2" />
            <static>
                Number 2
            </static>
            <return />
        </api>

        <api port="5000">
            <setHeader name="x-value" value="3" />
            <static>
                Number 3
            </static>
            <return />
        </api>
    </router>

</spring:beans>
# yaml-language-server: $schema=https://www.membrane-api.io/v7.1.0.json
#
# API on port 2000: fetch login cookie then proxy to backend
api:
  port: 2000
  flow:
    - request:
        - log:
            message: Calling login API
        - call:
            url: http://localhost:3000/login
        - log:
            message: "Got: ${header['set-cookie']}"
        # Inject received Set-Cookie header as Cookie
        - setHeader:
            name: Cookie
            value: ${header['set-cookie']}
  # Forward request (with cookie) to protected backend
  target:
    url: http://localhost:3001

---
# Simulated authentication service on port 3000
api:
  port: 3000
  path:
    uri: /login
  flow:
    - response:
      # Return a static SESSION cookie
      - setHeader:
          name: Set-Cookie
          value: SESSION=akj34
      - log:
          message: Logged in. Cookie is set.
    - return:
        status: 200

---
# Protected backend on port 3001
api:
  port: 3001
  flow:
    - request:
      - log:
          message: "Got: ${header['set-cookie']}"
      - if:
          test: cookie.SESSION != 'akj34'
          flow:
            - static:
                src: Unauthorized!
            - return:
                status: 401
    - response:
      - static:
          src: Success!
    - return:
        status: 200

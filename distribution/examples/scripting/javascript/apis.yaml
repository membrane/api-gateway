# yaml-language-server: $schema=https://www.membrane-api.io/v7.1.0.json

api:
  port: 2000
  flow:
    - request:
        - javascript:
            src: |
              console.log("Query parameters: " + params);
              // Return Json as Map
              ({ id: params.get('id')?.[0], city: params.get('city')?.[0] })
    - return:
        contentType: application/json

---
api:
  port: 2010
  flow:
    - request:
        - javascript:
            src: |
              // JSON to JSON transformation
                
              function convertDate(d) {
                return d.getFullYear() + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" + ("0"+d.getDate()).slice(-2);
              }
                
              ({
                id: json.id,
                date: convertDate(new Date(json.date)),
                client: json.customer,
                total: json.items.map(i => i.quantity * i.price).reduce((a,b) => a+b),
                positions: json.items.map(i => ({
                  pieces: i.quantity,
                  price: i.price,
                  article: i.description
                }))
              })
    - return:
        status: 200

---

api:
  port: 2020
  flow:
    - request:
        - javascript:
            src: |
              console.log("Request headers:")
            
              for (var entry of header.entrySet()) {
                console.log(entry.getKey() + ": " + entry.getValue());
              }
    - response:
        - javascript:
            src: |
              header.add("X-Javascript", "42") // Set Header
              CONTINUE
    - return:
        status: 200

package com.predic8.membrane.annot.util;

import com.predic8.membrane.annot.K8sHelperGenerator;
import com.predic8.membrane.annot.yaml.*;
import org.yaml.snakeyaml.Yaml;

import java.io.IOException;
import java.io.InputStreamReader;
import java.lang.reflect.InvocationTargetException;
import java.util.concurrent.CountDownLatch;

import static java.util.Objects.requireNonNull;

public class YamlParser {
    private final BeanRegistry beanRegistry;

    public YamlParser(String resourceName) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, InterruptedException {
        K8sHelperGenerator generator = (K8sHelperGenerator) getClass().getClassLoader()
                .loadClass("com.predic8.membrane.demo.config.spring.K8sHelperGeneratorAutoGenerated")
                .getConstructor()
                .newInstance();

        CountDownLatch cdl = new CountDownLatch(1);
        beanRegistry = GenericYamlParser.parseMembraneResources(getClass().getResourceAsStream(resourceName), generator,
                new BeanCacheObserver() {
                    @Override
                    public void handleAsynchronousInitializationResult(boolean empty) {
                        cdl.countDown();
                    }

                    @Override
                    public void handleBeanEvent(BeanDefinition bd, Object bean, Object oldBean, WatchAction action) throws IOException {

                    }

                    @Override
                    public boolean isActivatable(BeanDefinition bd) {
                        return true;
                    }
                });
        cdl.await();
    }

    public BeanRegistry getBeanRegistry() {
        return beanRegistry;
    }
}

package com.predic8.membrane.annot.util;

import com.predic8.membrane.annot.K8sHelperGenerator;
import com.predic8.membrane.annot.yaml.GenericYamlParser;
import org.yaml.snakeyaml.Yaml;

import java.io.InputStreamReader;
import java.lang.reflect.InvocationTargetException;

import static java.util.Objects.requireNonNull;

public class YamlParser {
    private final Object result;

    public YamlParser(String resourceName) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException {
        K8sHelperGenerator generator = (K8sHelperGenerator) getClass().getClassLoader()
                .loadClass("com.predic8.membrane.demo.config.spring.K8sHelperGeneratorAutoGenerated")
                .getConstructor()
                .newInstance();

        try (InputStreamReader reader = new InputStreamReader(
                requireNonNull(getClass().getResourceAsStream(resourceName)),
                java.nio.charset.StandardCharsets.UTF_8)) {
            this.result = GenericYamlParser.parseMembraneObject(
                    new Yaml().parse(reader).iterator(),
                    generator,
                    null);
        }
    }

    public Object getResult() {
        return result;
    }
}
